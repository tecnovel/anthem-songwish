{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/noahpique/Documents/AnthemTool/anthem-songwish/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n// Prevent multiple instances of Prisma Client in development (hot-reloading)\ndeclare global {\n  var __prisma: PrismaClient | undefined;\n}\n\nconst prisma = global.__prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") global.__prisma = prisma;\n\nexport default prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAOA,MAAM,SAAS,OAAO,QAAQ,IAAI,IAAI,6IAAY;AAElD,wCAA2C,OAAO,QAAQ,GAAG;uCAE9C","debugId":null}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///Users/noahpique/Documents/AnthemTool/anthem-songwish/src/pages/api/wish.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\n\nimport prisma from \"../../lib/prisma\";\n\ntype IncomingTrack = {\n  id: string;\n  name: string;\n  artists: string;\n  album?: string;\n  spotify_url?: string;\n  image_url?: string;\n  duration_ms?: number;\n};\n\ntype WishBody = {\n  firstName: string;\n  lastName: string;\n  email: string;\n  tracks: IncomingTrack[];\n  channel?: string;\n};\n\ntype SuccessResponse = {\n  success: true;\n};\n\ntype ErrorResponse = {\n  error: string;\n};\n\nfunction isNonEmptyString(value: unknown): value is string {\n  return typeof value === \"string\" && value.trim().length > 0;\n}\n\nfunction normalizeString(value: string): string {\n  return value.trim();\n}\n\nfunction normalizeOptionalString(value: unknown): string | undefined {\n  if (!isNonEmptyString(value)) {\n    return undefined;\n  }\n  return value.trim();\n}\n\nfunction validateBody(\n  payload: unknown\n): { body: WishBody } | { error: string } {\n  if (!payload || typeof payload !== \"object\") {\n    return { error: \"Invalid input: body must be an object.\" };\n  }\n\n  const candidate = payload as Partial<WishBody>;\n\n  if (!isNonEmptyString(candidate.firstName)) {\n    return { error: \"Invalid input: firstName is required.\" };\n  }\n\n  if (!isNonEmptyString(candidate.lastName)) {\n    return { error: \"Invalid input: lastName is required.\" };\n  }\n\n  if (!isNonEmptyString(candidate.email) || !candidate.email.includes(\"@\")) {\n    return { error: \"Invalid input: email must be a valid address.\" };\n  }\n\n  if (\n    !Array.isArray(candidate.tracks) ||\n    candidate.tracks.length < 1 ||\n    candidate.tracks.length > 3\n  ) {\n    return {\n      error: \"Invalid input: tracks must contain between 1 and 3 items.\",\n    };\n  }\n\n  const normalizedTracks: IncomingTrack[] = [];\n  const trackIds = new Set<string>();\n\n  for (let index = 0; index < candidate.tracks.length; index += 1) {\n    const trackCandidate = candidate.tracks[index];\n\n    if (!trackCandidate || typeof trackCandidate !== \"object\") {\n      return {\n        error: `Invalid input: track at position ${index + 1} is malformed.`,\n      };\n    }\n\n    const track = trackCandidate as IncomingTrack;\n\n    if (!isNonEmptyString(track.id)) {\n      return {\n        error: `Invalid input: track id missing at position ${index + 1}.`,\n      };\n    }\n\n    if (!isNonEmptyString(track.name)) {\n      return {\n        error: `Invalid input: track name missing at position ${index + 1}.`,\n      };\n    }\n\n    if (!isNonEmptyString(track.artists)) {\n      return {\n        error: `Invalid input: track artists missing at position ${index + 1}.`,\n      };\n    }\n\n    const normalizedTrack: IncomingTrack = {\n      id: normalizeString(track.id),\n      name: normalizeString(track.name),\n      artists: normalizeString(track.artists),\n      album: track.album ? track.album.trim() : undefined,\n      spotify_url: track.spotify_url ? track.spotify_url.trim() : undefined,\n      image_url: track.image_url ? track.image_url.trim() : undefined,\n      duration_ms:\n        typeof track.duration_ms === \"number\" ? track.duration_ms : undefined,\n    };\n\n    if (trackIds.has(normalizedTrack.id)) {\n      return { error: \"Invalid input: duplicate track ids are not allowed.\" };\n    }\n\n    trackIds.add(normalizedTrack.id);\n    normalizedTracks.push(normalizedTrack);\n  }\n\n  return {\n    body: {\n      firstName: normalizeString(candidate.firstName),\n      lastName: normalizeString(candidate.lastName),\n      email: normalizeString(candidate.email),\n      tracks: normalizedTracks,\n      channel: normalizeOptionalString(candidate.channel),\n    },\n  };\n}\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse<SuccessResponse | ErrorResponse>\n): Promise<void> {\n  if (req.method !== \"POST\") {\n    res.setHeader(\"Allow\", \"POST\");\n    res.status(405).json({ error: \"Method not allowed\" });\n    return;\n  }\n\n  try {\n    const rawPayload =\n      typeof req.body === \"string\" ? JSON.parse(req.body) : req.body;\n    const validationResult = validateBody(rawPayload);\n\n    if (\"error\" in validationResult) {\n      res.status(400).json({ error: validationResult.error });\n      return;\n    }\n\n    const { body } = validationResult;\n\n    const existingWish = await prisma.songWish.findFirst({\n      where: { email: body.email },\n    });\n\n    if (existingWish) {\n      res.status(409).json({\n        error: \"Es ist nur eine Wunschabgabe pro Person erlaubt.\",\n      });\n      return;\n    }\n\n    const data = body.tracks.map((track, index) => ({\n      firstName: body.firstName,\n      lastName: body.lastName,\n      email: body.email,\n      trackId: track.id,\n      trackName: track.name,\n      trackArtists: track.artists,\n      album: track.album ?? null,\n      imageUrl: track.image_url ?? null,\n      spotifyUrl: track.spotify_url ?? null,\n      durationMs: track.duration_ms ?? null,\n      slotIndex: index,\n      channel: body.channel ?? null,\n    }));\n\n    await prisma.songWish.createMany({ data });\n\n    res.status(200).json({ success: true });\n  } catch (error) {\n    console.error(\"Error in /api/wish:\", error);\n    res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}