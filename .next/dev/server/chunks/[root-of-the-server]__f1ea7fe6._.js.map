{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file:///Users/noahpique/Documents/AnthemTool/anthem-songwish/src/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\";\n\n// Prevent multiple instances of Prisma Client in development (hot-reloading)\ndeclare global {\n  var __prisma: PrismaClient | undefined;\n}\n\nconst prisma = global.__prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== \"production\") global.__prisma = prisma;\n\nexport default prisma;\n"],"names":[],"mappings":";;;;AAAA;;AAOA,MAAM,SAAS,OAAO,QAAQ,IAAI,IAAI,6IAAY;AAElD,wCAA2C,OAAO,QAAQ,GAAG;uCAE9C","debugId":null}},
    {"offset": {"line": 35, "column": 0}, "map": {"version":3,"sources":["file:///Users/noahpique/Documents/AnthemTool/anthem-songwish/src/pages/api/admin/export.ts"],"sourcesContent":["import type { NextApiRequest, NextApiResponse } from \"next\";\nimport type { Prisma } from \"@prisma/client\";\n\nimport prisma from \"../../../lib/prisma\";\n\nfunction buildWhereClause(\n  query: string | undefined\n): Prisma.SongWishWhereInput {\n  if (!query) {\n    return {};\n  }\n\n  const trimmed = query.trim();\n  if (!trimmed) {\n    return {};\n  }\n\n  return {\n    OR: [\n      { trackName: { contains: trimmed, mode: \"insensitive\" as const } },\n      { trackArtists: { contains: trimmed, mode: \"insensitive\" as const } },\n      { firstName: { contains: trimmed, mode: \"insensitive\" as const } },\n      { lastName: { contains: trimmed, mode: \"insensitive\" as const } },\n      { email: { contains: trimmed, mode: \"insensitive\" as const } },\n    ],\n  };\n}\n\nfunction toCsvLine(fields: (string | number | null | undefined)[]): string {\n  return fields\n    .map((field) => {\n      if (field === null || field === undefined) {\n        return \"\";\n      }\n\n      const value = String(field);\n      if (value.includes(\",\") || value.includes(\"\\n\") || value.includes('\"')) {\n        return `\"${value.replace(/\"/g, '\"\"')}\"`;\n      }\n\n      return value;\n    })\n    .join(\",\");\n}\n\nexport default async function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n): Promise<void> {\n  if (req.method !== \"GET\") {\n    res.setHeader(\"Allow\", \"GET\");\n    res.status(405).json({ error: \"Method not allowed\" });\n    return;\n  }\n\n  const groupedValue = Array.isArray(req.query.grouped)\n    ? req.query.grouped[0]\n    : req.query.grouped;\n  const groupedParam = (groupedValue ?? \"true\").toString().toLowerCase();\n  const grouped = groupedParam !== \"false\";\n  const searchValue = Array.isArray(req.query.q) ? req.query.q[0] : req.query.q;\n  const searchQuery = typeof searchValue === \"string\" ? searchValue : undefined;\n\n  try {\n    const where = buildWhereClause(searchQuery);\n\n    const wishes = await prisma.songWish.findMany({\n      where,\n      orderBy: { createdAt: \"desc\" },\n    });\n\n    let csv = \"\";\n\n    if (grouped) {\n      const map = new Map<\n        string,\n        {\n          count: number;\n          trackName: string;\n          trackArtists: string;\n          album?: string | null;\n          spotifyUrl?: string | null;\n          names: Set<string>;\n        }\n      >();\n\n      for (const wish of wishes) {\n        const existing = map.get(wish.trackId);\n        const requester = `${wish.firstName} ${wish.lastName}`.trim();\n        if (existing) {\n          existing.count += 1;\n          if (requester) existing.names.add(requester);\n        } else {\n          const names = new Set<string>();\n          if (requester) names.add(requester);\n          map.set(wish.trackId, {\n            count: 1,\n            trackName: wish.trackName,\n            trackArtists: wish.trackArtists,\n            album: wish.album,\n            spotifyUrl: wish.spotifyUrl,\n            names,\n          });\n        }\n      }\n\n      const ranked = Array.from(map.entries())\n        .map(([trackId, info]) => ({ trackId, ...info }))\n        .sort((a, b) => {\n          if (b.count !== a.count) {\n            return b.count - a.count;\n          }\n          return a.trackName.localeCompare(b.trackName);\n        });\n\n      csv += toCsvLine([\n        \"rank\",\n        \"votes\",\n        \"trackName\",\n        \"trackArtists\",\n        \"album\",\n        \"spotifyUrl\",\n        \"names\",\n      ]);\n      csv += \"\\n\";\n\n      ranked.forEach((item, index) => {\n        const namesList = item.names ? Array.from(item.names).join(\"; \") : \"\";\n        csv += toCsvLine([\n          index + 1,\n          item.count,\n          item.trackName,\n          item.trackArtists,\n          item.album ?? \"\",\n          item.spotifyUrl ?? \"\",\n          namesList,\n        ]);\n        csv += \"\\n\";\n      });\n    } else {\n      csv += toCsvLine([\n        \"createdAt\",\n        \"firstName\",\n        \"lastName\",\n        \"email\",\n        \"trackName\",\n        \"trackArtists\",\n        \"album\",\n        \"spotifyUrl\",\n        \"slotIndex\",\n        \"channel\",\n      ]);\n      csv += \"\\n\";\n\n      wishes.forEach((wish) => {\n        csv += toCsvLine([\n          wish.createdAt.toISOString(),\n          wish.firstName,\n          wish.lastName,\n          wish.email,\n          wish.trackName,\n          wish.trackArtists,\n          wish.album ?? \"\",\n          wish.spotifyUrl ?? \"\",\n          wish.slotIndex,\n          wish.channel ?? \"\",\n        ]);\n        csv += \"\\n\";\n      });\n    }\n\n    res.setHeader(\"Content-Type\", \"text/csv; charset=utf-8\");\n    res.setHeader(\n      \"Content-Disposition\",\n      `attachment; filename=\"songwishes_${grouped ? \"grouped\" : \"raw\"}.csv\"`\n    );\n\n    res.status(200).send(csv);\n  } catch (error) {\n    console.error(\"Error in /api/admin/export:\", error);\n    res.status(500).json({ error: \"Internal server error\" });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}